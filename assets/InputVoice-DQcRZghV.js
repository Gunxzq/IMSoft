import{d as e,r as a,b as l,g as t,k as n,z as u,i as r,u as o,j as s,D as v,M as i,E as c,I as d,e as p,F as m,f as h,n as w,J as y,T as f}from"./vendor-DtIIXuVc.js";import{b as g,e as E,E as _,M as k,_ as S}from"./index-BD3GTcF9.js";const b={class:"container"},I=S(e({name:"InputVoice",emits:["startRecord","recordComplete","convertToTextComplete"],setup(e,{expose:S,emit:I}){let C=a(null),R=a([]),L=a("inactive"),T=a(0),M=a(null),U=a(Array(5).fill(2)),j=a(""),x=a("按住说话"),A=a(null),$=a(""),D=a(!1),O=a(""),z=a(""),N=null;const P=async()=>{var e,a;try{await(async()=>{try{const e=await navigator.mediaDevices.getUserMedia({video:!1,audio:{echoCancellation:!0,noiseSuppression:!0,channelCount:1,sampleRate:44100}});C.value=new MediaRecorder(e),R.value=[],C.value.ondataavailable=e=>{e.data.size>0&&R.value.push(e.data)},C.value.onstop=()=>{A.value=new Blob(R.value,{type:"audio/webm"}),j.value=URL.createObjectURL(A.value),$.value=j.value}}catch(e){}})(),await(async()=>{try{const e=window.SpeechRecognition||window.webkitSpeechRecognition;e&&(N=new e,N&&(N.lang="zh-CN",N.interimResults=!0,N.continuous=!0,O.value="",z.value="",D.value=!0,N.onresult=e=>{let a="",l="";for(let t=e.resultIndex;t<e.results.length;t++){const n=e.results[t][0].transcript;e.results[t].isFinal?l+=n+" ":a+=n}z.value=a,O.value+=l.trim()},N.onerror=e=>{D.value=!1},N.onend=()=>{D.value}))}catch(e){}})(),null==(e=C.value)||e.start(100),N&&N.start(),L.value="recording",T.value=0,M.value=setInterval(()=>{T.value++,X()},1e3)}catch(l){"recording"===(null==(a=C.value)?void 0:a.state)&&(C.value.stop(),C.value.stream.getTracks().forEach(e=>e.stop())),null==N||N.stop(),clearInterval(M.value),H(),j.value="",q()}},B=()=>{C.value&&(C.value.stop(),C.value.stream.getTracks().forEach(e=>e.stop()),null==N||N.stop()),clearInterval(M.value),H(),L.value="inactive",q()},F=async()=>{await G();const e=j.value,a=document.createElement("a");a.href=e,a.download=`录音_${(new Date).toISOString().slice(0,19).replace(/:/g,"-")}.webm`,document.body.appendChild(a),a.click(),document.body.removeChild(a),H(),q()},G=()=>new Promise((e,a)=>{var l,t,n,u;if(!C.value&&"recording"===L.value)return void e(!0);const r=()=>{var a,l;null==(a=C.value)||a.removeEventListener("stop",r),R.value.length>0&&(A.value=new Blob(R.value,{type:null==(l=C.value)?void 0:l.mimeType}),j.value=URL.createObjectURL(A.value)),e(!0)},o=e=>{var l;null==(l=C.value)||l.removeEventListener("error",o),a(new Error("录音停止失败"))};null==(l=C.value)||l.addEventListener("stop",r),null==(t=C.value)||t.addEventListener("error",o),clearInterval(M.value),null==(n=C.value)||n.stop(),null==(u=C.value)||u.stream.getTracks().forEach(e=>e.stop()),null==N||N.stop()}),V=async()=>{if(await G(),j.value&&A.value)try{const e=`url==${await g(A.value)}$duration==${T.value}`;H(),q(),E.emit(_.API_SEND_MESSAGE,{content:e,type:k.VOICE})}catch(e){}},J=async()=>{if(await G(),!O.value||O.value.length<=0)return j.value="",void q();try{const e=O.value;j.value="",q(),E.emit(_.API_SEND_MESSAGE,{content:e,type:k.TEXT})}catch(e){}},X=()=>{},q=()=>{L.value="inactive",clearInterval(M.value),U.value=Array(5).fill(2),T.value=0},H=()=>{j.value&&""!==j.value&&URL.revokeObjectURL(j.value),j.value=""};return S({unmounted:()=>{C.value&&C.value.stream.getTracks().forEach(e=>e.stop()),clearInterval(M.value),H(),null==N||N.stop(),N=null}}),(e,a)=>(t(),l("div",b,["inactive"==o(L)?(t(),n(c,{key:0,onClick:P,style:{width:"100%"}},{default:s(()=>[v(i(o(x)),1)]),_:1})):u("",!0),r(f,{name:"slide-up"},{default:s(()=>{return[d(p("div",null,[p("div",null,[p("div",null,[p("span",null,i((e=o(T),`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`)),1),(t(!0),l(m,null,h(o(U),(e,a)=>(t(),l("span",{key:a,class:"wave-bar",style:w({height:e+"px"})},null,4))),128))])]),p("div",null,[r(c,{onClick:B,icon:"mdi-close"}),r(c,{onClick:V},{default:s(()=>a[0]||(a[0]=[v("完成")])),_:1,__:[0]}),r(c,{onClick:F},{default:s(()=>a[1]||(a[1]=[v("录音")])),_:1,__:[1]}),r(c,{onClick:J,icon:""},{default:s(()=>a[2]||(a[2]=[v("文")])),_:1,__:[2]})])],512),[[y,"recording"===o(L)]])];var e}),_:1})]))}}),[["__scopeId","data-v-52926ff4"]]);export{I as default};
