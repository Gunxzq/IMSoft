const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/TextMessage-CFIfDmlv.js","assets/vendor-DtIIXuVc.js","assets/vendor-Bq4oDfxg.css","assets/TextMessage-CV0Pld7t.css","assets/ImageMessage-DNqX1p0o.js","assets/ImageMessage-CilhVgWR.css","assets/FileMessage-BJpLfulh.js","assets/FileMessage-N8aujRIB.css","assets/VideoMessage-BnuPdg6e.js","assets/VideoMessage-BytaH_x8.css","assets/VoiceMessage-0xdTd8uT.js","assets/VoiceMessage-Bx6_sp7E.css","assets/LocationMessage-COA69NRk.js","assets/LinkMessage-JiM6STeF.js","assets/InputEmoj-D9cxdu2T.js","assets/InputEmoj-WKNF-M95.css","assets/InputVoice-DQcRZghV.js","assets/InputVoice-hNd_7Sju.css","assets/moreActions-CwACbKKP.js","assets/moreActions-dhbyEAXN.css"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{d as s,r as a,a as n,w as o,c as i,o as r,b as l,u as c,e as u,n as d,F as m,f as v,g as p,h as g,i as h,j as f,k as _,l as I,m as E,p as y,q as k,s as w,t as S,v as M,x as A,y as b,V as L,z as x,A as P,B as O,C as T,D as C,T as N,E as D,G as j,H as R,I as V,J as U,K as H,L as z,M as G,N as $,O as W,P as q,Q as F,R as X}from"./vendor-DtIIXuVc.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const J={},K=function(e,t,s){let a=Promise.resolve();if(t&&t.length>0){let e=function(e){return Promise.all(e.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),n=(null==s?void 0:s.nonce)||(null==s?void 0:s.getAttribute("nonce"));a=e(t.map(e=>{if((e=function(e){return"/IMSoft/"+e}(e))in J)return;J[e]=!0;const t=e.endsWith(".css"),s=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${s}`))return;const a=document.createElement("link");return a.rel=t?"stylesheet":"modulepreload",t||(a.as="script"),a.crossOrigin="",a.href=e,n&&a.setAttribute("nonce",n),document.head.appendChild(a),t?new Promise((t,s)=>{a.addEventListener("load",t),a.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function n(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(t=>{for(const e of t||[])"rejected"===e.status&&n(e.reason);return e().catch(n)})},Y=["data-id"],B=(e,t)=>{const s=e.__vccOpts||e;for(const[a,n]of t)s[a]=n;return s},Q=B(s({name:"VirtualList",props:{dataList:{},getItemHeight:{},estimatedItemHeight:{default:100},buffer:{default:200},slotName:{default:"default"}},emits:["scroll","resize"],setup(e,{emit:t}){const s=e,h=t,f=a(null),_=a(0),I=a(new Map),E=a({start:0,end:0}),y=a([]),k=a(0),w=a(new Map),S=()=>{if(!f.value)return;const e=f.value.clientHeight,t=s.dataList,a=s.estimatedItemHeight;let n=0;I.value.clear(),w.value.clear(),t.forEach((e,t)=>{const a=e.id;let o=I.value.get(a);void 0===o&&(o=s.getItemHeight(e,t),I.value.set(a,o)),n+=o,w.value.set(a,n)}),k.value=n;let o=_.value,i=0,r=t.length,l=0;for(let s=0;s<t.length;s++)if(l+=I.value.get(t[s].id),o<l){i=s;break}o=_.value+e;for(let s=i;s<t.length;s++)if(l+=I.value.get(t[s].id),o<l){r=s+1;break}i=Math.max(0,i-Math.floor(s.buffer/a)),r=Math.min(t.length,r+Math.ceil(s.buffer/a)),E.value={start:i,end:r},y.value=t.slice(i,r).map((e,t)=>({id:e.id,data:e,height:I.value.get(e.id),originalIndex:i+t}))},M=e=>{const t=s.dataList.find(t=>t.id===e);return t?t.originalIndex:-1},A=n(e=>{_.value=e.target.scrollTop,h("scroll",_.value)},50);o(()=>s.dataList,S,{deep:!0}),o(_,()=>{S()});const b=i(()=>{const e=E.value.start;let t=0;for(let a=0;a<e;a++){const e=s.dataList[a].id;t+=I.value.get(e)||s.estimatedItemHeight}return t});return r(()=>{S(),h("resize",{totalHeight:k.value,visibleCount:y.value.length})}),(e,t)=>(p(),l("div",{ref_key:"containerRef",ref:f,class:"virtual-list-container",onScroll:t[0]||(t[0]=(...e)=>c(A)&&c(A)(...e))},[u("div",{class:"virtual-list-phantom",style:d({height:k.value+"px"})},null,4),u("div",{class:"virtual-list-content",style:d({transform:`translateY(${b.value}px)`})},[(p(!0),l(m,null,v(y.value,t=>(p(),l("div",{key:t.id,"data-id":t.id,class:"virtual-list-item",style:d({height:t.height+"px"})},[g(e.$slots,"default",{item:t,index:M(t.id)},void 0)],12,Y))),128))],4)],544))}}),[["__scopeId","data-v-05644a95"]]),Z={TEXT:"text",IMAGE:"image",VOICE:"voice",VIDEO:"video",FILE:"file",LOCATION:"location",LINK:"link"},ee={class:"chat-container",style:{height:"800px",width:"600px"}},te=s({name:"MessageList",props:{messages:{type:Array,required:!0}},setup(e){const t=E(()=>K(()=>import("./TextMessage-CFIfDmlv.js"),__vite__mapDeps([0,1,2,3]))),s=E(()=>K(()=>import("./ImageMessage-DNqX1p0o.js"),__vite__mapDeps([4,1,2,5]))),a=E(()=>K(()=>import("./FileMessage-BJpLfulh.js"),__vite__mapDeps([6,1,2,7]))),n=E(()=>K(()=>import("./VideoMessage-BnuPdg6e.js"),__vite__mapDeps([8,1,2,9]))),o=E(()=>K(()=>import("./VoiceMessage-0xdTd8uT.js"),__vite__mapDeps([10,1,2,11]))),i=E(()=>K(()=>import("./LocationMessage-COA69NRk.js"),__vite__mapDeps([12,1,2]))),r=E(()=>K(()=>import("./LinkMessage-JiM6STeF.js"),__vite__mapDeps([13,1,2]))),c=e,u=e=>{switch(e.type){case Z.TEXT:const t=23,s=e.content.length,a=(e.content.match(/\n/g)||[]).length;return 40+20*(a+1+Math.ceil((s-a)/t))+0;case Z.IMAGE:return"auto";case Z.VOICE:return 60;case Z.VIDEO:return"auto";case Z.FILE:case Z.LOCATION:case Z.LINK:return 100;default:return 60}},d=e=>{};return(e,m)=>(p(),l("div",ee,[h(Q,{dataList:c.messages,getItemHeight:u,buffer:200,onScroll:d},{default:f(({item:e})=>{return[(p(),_(I((l=e.data.type,{[Z.TEXT]:t,[Z.IMAGE]:s,[Z.VOICE]:o,[Z.VIDEO]:n,[Z.FILE]:a,[Z.LOCATION]:i,[Z.LINK]:r}[l]||t)),{message:e.data},null,8,["message"]))];var l}),_:1},8,["dataList"])]))}}),se=y("userinfo",()=>{let e=a(""),t=a("1");const s=a({});return{userStatus:s,token:e,userId:t,updateUserStatus:(e,t)=>{s.value[e]={online:t,lastActive:Date.now()}}}});const ae=new class{constructor(){t(this,"socket",null),t(this,"EventList",null),t(this,"globalMiddlewares",[]),this.socket=k("http://localhost:3000",{auth:{token:"f",userId:"1"}}),this.socket.onAny((e,t)=>{this.executeMiddlewares(e,t)}),this.connect()}connect(){var e,t;null==(e=this.socket)||e.on("connect",()=>{}),null==(t=this.socket)||t.on("disconnect",e=>{})}disconnect(){var e;null==(e=this.socket)||e.disconnect()}get isConnected(){var e;return!!(null==(e=this.socket)?void 0:e.connected)}getSocket(){if(!this.socket)throw new Error("WebSocket not connected");return this.socket}emitEvent(e,t){var s;return null==(s=this.socket)||s.emit(e,t),this.socket}onEvent(e,t){var s,a;return null==(s=this.EventList)||s.push(e),null==(a=this.socket)||a.on(e,t),this.socket}offEvent(e){var t;return null==(t=this.socket)||t.off(e),this.socket}use(e){this.globalMiddlewares.push(e)}async executeMiddlewares(e,t){let s=0;const a=async()=>{if(s>=this.globalMiddlewares.length)return void this.handleOriginalEvent(e,t);const n=this.globalMiddlewares[s++];await n({event:e,data:t,socket:this.socket},a)};await a()}handleOriginalEvent(e,t){}};ae.use(async({event:e,data:t},s)=>{const a=Date.now();try{await s();Date.now()}catch(n){throw n}}),ae.use(async({socket:e,event:t},s)=>{"object"==typeof e.auth&&null!==e.auth&&"token"in e.auth&&s()}),ae.use(({data:e},t)=>{("message"!==e.type||e.content)&&t()});const ne="conversations",oe="aggregations",ie="unreadCount";function re(e,t){return[e,t].sort().join("-")}function le(e){return"group:"+e}function ce(e){return ue(e[0])?le(e[0]):re(e[0],e[1])}function ue(e){return e.startsWith("group:")}const de=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});function me(e){const t=e.split("$"),s={};for(const a of t){if(!a)continue;const[e,t]=a.split("==",2);e&&void 0!==t&&(s[e]=t)}return s}function ve(){return`${Date.now()}-${Math.random().toString(36).substr(2,5)}`}function pe(e){return new Promise((t,s)=>{const a=new FileReader;a.onload=()=>t(a.result),a.onerror=e=>s(e),a.readAsDataURL(e)})}const ge=y("globalMenu",()=>{let e=a(!1),t=w({menuX:0,menuY:0,menuHeight:0,menuWidth:0}),s=a([]),n=a();const o=()=>{e.value=!1};return{showMenu:function(s,a){!1===e.value?e.value=!0:o(),s+t.menuWidth>window.innerWidth?t.menuX=window.innerWidth-t.menuWidth:t.menuX=s,t.menuY=a},showContextMenu:e,initItem:function(e,t){s.value=e,n.value=t},hideMenu:o,menuSize:t,menuItems:s,context:n}}),he=y("messages",()=>{const{userId:e}=S(se());let t=w(function(e){let t=localStorage.getItem(ne),s={};if(t)try{s=JSON.parse(t)}catch(a){}return s[e]||(s[e]={},localStorage.setItem(ne,JSON.stringify(s))),s[e]}(e.value)),s=w(function(e){let t=localStorage.getItem(oe),s={};if(t)try{s=JSON.parse(t)}catch(a){}return s[e]||(s[e]={},localStorage.setItem(oe,JSON.stringify(s))),s[e]}(e.value)),n=w(function(e){let t=localStorage.getItem(ie),s={};if(t)try{s=JSON.parse(t)}catch(a){}return s[e]||(s[e]={},localStorage.setItem(ie,JSON.stringify(s))),s[e]}(e.value)),o=a("A"),r=a("");const l=i(()=>{const s=t[ce([o.value,e.value])];return s&&Array.isArray(s.messages)?s.messages.map(t=>({id:t.id,content:t.content,type:t.type,time:de(t.timestamp),isSelf:t.sender===e.value,userId:t.sender})).sort((e,t)=>((null==t?void 0:t.timestamp)||0)-(e.timestamp||0)):[]}),c=(e,s,a,o,i=!1,r)=>{t[e]||(t[e]={participants:i?[le(r),s,a]:[s,a],messages:[]});const l=t[e];i&&(l.participants.includes(s)&&l.participants.includes(a)||l.participants.push(s,a)),l.messages.push(o),void 0===n[e]&&(n[e]=0)},u=i(()=>Object.values(s).map(t=>({id:t.lastMessage.id,content:ue(t.participants[0])?t.lastMessage.sender===e.value?t.lastMessage.content:""+t.lastMessage.content:t.lastMessage.content,type:t.lastMessage.type,time:de(t.lastMessage.timestamp),userId:ue(t.participants[0])?t.participants[0]:t.lastMessage.sender===e.value?t.lastMessage.receiver:t.lastMessage.sender,isGroup:ue(t.participants[0]),unreadCount:n[ce(t.participants)]})).sort((e,t)=>{var s,a;return((null==(s=t.lastMessage)?void 0:s.timestamp)||0)-((null==(a=e.lastMessage)?void 0:a.timestamp)||0)})),d=(e,t,a,o,i=!1,r)=>{s[e]||(s[e]={participants:i?[le(r),t,a]:[t,a],lastMessage:o});s[e].lastMessage=o,void 0===n[e]&&(n[e]=0)};return{sendMessage:(e,t,s,a,o=!1,i,r=!0)=>{const l={id:ve(),sender:e,receiver:t,content:s,type:a,timestamp:Date.now()};let u=o?le(i):re(e,t);d(u,e,t,l,o,i),c(u,e,t,l,o,i),r?n[u]=0:n[u]++},currentAggregations:u,currentConversations:l,currentConversationId:o,currentMessage:r,deleteMessage:a=>{const n=ce([o.value,e.value]);let i=t[n].messages;a===s[n].lastMessage.id&&(s[n].lastMessage=i[i.length-1]),i=i.filter(e=>e.id!==a),t[n].messages=i}}});let fe=M();const _e=[{text:"回复",action:"click",callback:e=>{}},{text:"转发",action:"click",callback:()=>{}},{text:"收藏",action:"click",callback:()=>{}},{text:"删除",action:"click",callback:()=>{}},{text:"举报",action:"click",callback:()=>{}},{text:"分享",action:"click",callback:()=>{}},{text:"查看上下文",action:"click",callback:()=>{}}],Ie={MessageStore:he(fe),GlobalMenuStore:ge(fe)};var Ee=(e=>(e.API_UN_AUTH="API:UN_AUTH",e.API_VALIDATE_ERROR="API:VALIDATE_ERROR",e.API_LOGIN="API:LOGIN",e.API_INPUT_UPDATE="API:INPUT_UPDATE",e.API_SEND_MESSAGE="API:SEND_MESSAGE",e))(Ee||{});const ye=new class{constructor(){t(this,"listeners"),this.listeners={"API:UN_AUTH":new Set,"API:VALIDATE_ERROR":new Set,"API:LOGIN":new Set,"API:INPUT_UPDATE":new Set,"API:SEND_MESSAGE":new Set}}on(e,t){var s;((s=this.listeners)[e]??(s[e]=new Set)).add(t)}emit(e,...t){this.listeners[e].forEach(e=>e(...t))}off(e,t){var s;((s=this.listeners)[e]??(s[e]=new Set)).delete(t)}once(e,t){const s=(...a)=>{this.off(e,s),t(...a)};this.on(e,s)}},ke=A.create({baseURL:"/api",timeout:5e3});ke.interceptors.request.use(e=>{const t=se();return t.token&&(e.headers.Authorization="Bearer "+t.token),e}),ke.interceptors.response.use(e=>e.data,e=>{let t="";switch(e.response.status){case 401:t="token过期",ye.emit("API:UN_AUTH");break;case 403:t="无权访问";break;case 404:t="请求地址错误";break;case 500:t="服务器出现问题";break;default:t="网络问题"}return Promise.reject(e)});const we=s({name:"InputText",emits:["rowsChange"],setup(e,{emit:t}){const s=he();let o=a(null),i=a(0);const l=t,u=n(async e=>{s.currentMessage=e.target.value;let t=await d();l("rowsChange",t)},500),d=()=>new Promise(e=>{b(()=>{var t,s;const a=null==(s=null==(t=o.value)?void 0:t.$el)?void 0:s.querySelector(".v-input__control");if(a){let t=new Number(window.getComputedStyle(a).height.replace("px",""));t/=2,t>i.value?e(!0):e(!1)}})});return r(async()=>{i.value=await new Promise(e=>{b(()=>{var t,s;const a=null==(s=null==(t=o.value)?void 0:t.$el)?void 0:s.querySelector(".v-textarea__sizer");if(a){let t=window.getComputedStyle(a).height.replace("px","");e(new Number(t))}else e(36)})}),ye.on(Ee.API_INPUT_UPDATE,e=>{b(()=>{var t;let s=null==(t=o.value)?void 0:t.$el.querySelector("textarea");s.focus(),s.value=e;const a=new Event("input",{bubbles:!0,cancelable:!0});s.dispatchEvent(a)})})}),(e,t)=>(p(),_(L,{ref_key:"textAreaRef",ref:o,variant:"solo",rows:"1","hide-details":"",maxlength:"4500","max-rows":"6","auto-grow":"",autofocus:"",onInput:c(u)},null,8,["onInput"]))}}),Se=B(s({name:"InputMessage",setup(e){const t=E(()=>K(()=>import("./InputEmoj-D9cxdu2T.js"),__vite__mapDeps([14,1,2,15]))),s=E(()=>K(()=>import("./InputVoice-DQcRZghV.js"),__vite__mapDeps([16,1,2,17]))),a=E(()=>K(()=>import("./moreActions-CwACbKKP.js"),__vite__mapDeps([18,1,2,19]))),n=se(),o=he(),u=w({classChange:!1,actionState:"text"}),m=e=>{var t;const s=null==(t=e.target)?void 0:t.dataset.action;if(s)switch(s){case"emoj":"emoj"===u.actionState?u.actionState="text":u.actionState="emoj";break;case"more":"more"===u.actionState?u.actionState="text":u.actionState="more";break;case"voice":u.actionState="voice";break;case"text":u.actionState="text"}},v=i(()=>!!o.currentMessage),g=()=>{o.sendMessage(n.userId,o.currentConversationId,o.currentMessage,Z.TEXT),o.currentMessage=""};return r(()=>{ye.on(Ee.API_SEND_MESSAGE,e=>{o.sendMessage(n.userId,o.currentConversationId,e.content,e.type)})}),(e,n)=>(p(),l("div",{class:"container",onClick:m},[h(P,{style:d(u.classChange?"align-items: flex-end":"")},{default:f(()=>[h(O,{cols:"1",class:"justify-center"},{default:f(()=>["text"===u.actionState?(p(),_(T,{key:0,size:"40","data-action":"voice"},{default:f(()=>n[1]||(n[1]=[C("mdi-microphone-outline")])),_:1,__:[1]})):(p(),_(T,{key:1,size:"40","data-action":"text"},{default:f(()=>n[2]||(n[2]=[C("mdi-keyboard-outline")])),_:1,__:[2]}))]),_:1}),h(O,{cols:"8"},{default:f(()=>["text"===u.actionState?(p(),_(we,{key:0,onRowsChange:n[0]||(n[0]=e=>u.classChange=e)})):(p(),_(c(s),{key:1,style:{width:"100%"}}))]),_:1}),h(O,{cols:"1",class:"justify-center"},{default:f(()=>[v.value?x("",!0):(p(),_(T,{key:0,size:"40","data-action":"emoj"},{default:f(()=>n[3]||(n[3]=[C("mdi-emoticon-outline")])),_:1,__:[3]}))]),_:1}),h(O,{cols:"1",class:"justify-center"},{default:f(()=>[v.value?x("",!0):(p(),_(T,{key:0,size:"40","data-action":"more"},{default:f(()=>n[4]||(n[4]=[C("mdi-plus-circle-outline")])),_:1,__:[4]}))]),_:1})]),_:1},8,["style"]),h(N,{name:"slide-up"},{default:f(()=>["emoj"==u.actionState?(p(),_(c(t),{key:0})):x("",!0)]),_:1}),h(N,{name:"slide-up"},{default:f(()=>["more"==u.actionState?(p(),_(c(a),{key:0})):x("",!0)]),_:1}),v.value?(p(),_(D,{key:0,onClick:g},{default:f(()=>n[5]||(n[5]=[C("发送")])),_:1,__:[5]})):x("",!0)]))}}),[["__scopeId","data-v-0cae0f0c"]]),Me={style:{height:"800px",width:"800px",border:"1px solid red"}},Ae=B(s({__name:"App",setup(e){const t=he(),s=ge();return r(()=>{window.addEventListener("contextmenu",e=>{e.preventDefault(),s.hideMenu()}),window.addEventListener("click",()=>{s.hideMenu()})}),j(()=>{window.removeEventListener("contextmenu",e=>{e.preventDefault()}),window.addEventListener("click",()=>{})}),(e,s)=>{const a=R("global-menu");return p(),l(m,null,[u("div",Me,[h(te,{messages:c(t).currentConversations},null,8,["messages"])]),h(Se,{class:"input-message"}),h(a)],64)}}}),[["__scopeId","data-v-9bfee5c6"]]),be={class:"v-overlay__content"},Le=B(s({name:"globalMenu",setup(e){const t=ge();let s=a(null);return o(()=>t.menuItems,()=>{b(()=>{let e=s.value.$el.offsetHeight,a=s.value.$el.offsetWidth;t.menuSize.menuHeight=e,t.menuSize.menuWidth=a})},{deep:!0}),(e,a)=>V((p(),l("div",{style:d({left:c(t).menuSize.menuX+"px",top:c(t).menuSize.menuY+"px"}),class:"menu v-menu v-overlay"},[u("div",be,[h($,{dense:"","data-aa":"mm",ref_key:"globalMenu",ref:s},{default:f(()=>[(p(!0),l(m,null,v(c(t).menuItems,(e,s)=>(p(),_(H,{key:s,onClick:s=>function(e){e.callback(W(t.context))}(e)},{default:f(()=>[h(z,null,{default:f(()=>[C(G(e.text),1)]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1},512)])],4)),[[U,c(t).showContextMenu]])}}),[["__scopeId","data-v-c929f942"]]),xe=q(Ae);xe.use(fe);const Pe=F({icons:{defaultSet:"mdi"},theme:{defaultTheme:"light",themes:{light:{colors:{primary:"#4CAF50",secondary:"#FFC107"}}}}});X.setOptions({gfm:!0,breaks:!0,pedantic:!1}),xe.use(Pe),xe.component("globalMenu",Le),xe.mount("#app");export{_e as C,Ee as E,Z as M,B as _,Ie as a,pe as b,ye as e,ve as g,me as p};
